# Техническое описание проекта

----

## 1. Общее:

- при запуске главного файла main.py создаётся База данных в PostgreSQL и все необходимые таблицы в ней. Если База данных или таблицы уже созданы, то повторное создание не произойдёт;
- при нажатии на кнопку "Найти половинку" или "Фильтры для поиска" - происходит первичная инициализация пользователя, данные о нём сохраняются 1 раз в в PostgreSQL;
- информация о фильтрах, список избранного/чс, фильтры пользователя, подходящие люди для показа сохраняются в PostgreSQL;
- весь кеш (чтобы переходить на предыдущую анкету, показ истории просмотров и т.д.) сохраняется в Redis;
- tg bot также сохраняет информацию о пользователях в кеш (только tg_id пользователей, которые им пользуются);
- ВК имеет ограничение на изменение клавиатуры. Если один и тот же пользователь будет часто перелистывать анкеты, то ВК может выдать проблему " [9] Flood control: too much messages sent to user". Для решения этой проблемы необходимо либо увеличить количество токен ВК бота, и при получении данной ошибке изменять токен на другой, либо использовать клавиши под сообщениями, за место Inline клавиш.

## 2. Модуль main.py в главной директории проекта:

Модуль выполняет три гланвых действия во время запусках:
1) создание Базы Данных и таблиц в PostgreSQL, если они ещё не созданы
2) запускает телеграм бота, если он включен (include = True) в ```settings.py```
3) запускает самого бота ВК

В модуле также расставлены логи об основных действиях и ошибках программы, которые будут отправлять в телеграм бот к пользователю.

Бот ВК и ТГ работают параллельно за счет двух процессов threading.Thread() библиотеки threading.

## 3. Модуль settings.py в главной директории проекта:

В модуле прописаны настройки, которые необходимо верно указать при подключении к PostgreSQL, Redis и TG боту. Также можно выбрать размер кеша в переменной ```HISTORY_SIZE```, которая отвечает за то, сколько анкет в памяти будут сохраняться для истории просмотров.

При необходимости можно указать версию VK API в переменной ```HISTORY_SIZE```

## 4. Модуль test_settings.py в главной директории проекта:

Модуль предназначен для настройки PostgreSQL и Redis для тестов. Важно указать базу данных отличную от той, что используется основной программой, чтобы не потерять данные.

> Для его работы необходимо указать данные в файле .env для тестов + укажите свой id_vk_for_test, после чего необходимо нужно начать переписку с ботом ВК, который указан в тестах. Это нужно для корректной работы некоторых тестов в tests_bot_function, в них БОТ ВК будет отправлять к вам в диалог тестовые сообщения.

## 5. Директория tests_project:

В директории находятся основные unittest для тестирования программы. Для корректной работы всех тестов в файле ```.env``` необходимо указать все данные для тестов. Для тестов желательно иметь другие токены для VK API и VK BOT. 

## 6. Модуль vk_bot_main.py в главной директории проекта:

В данном модуле представлена одна функция vk_bot, которая ничего не принимает и не возвращает. Она запускает ВК бота и определяет основную его работу, используя функции в директориях api_vk, database и vk_bot.

При каждом отправленном сообщении или нажатой кнопки пользователем в чате с ВК ботом отправляется запрос в данную функцию, после чего он обрабатывается и БОТ возвращает ответ пользователю.

## 7. Директория logs:

Директория предназначена для работы ТГ бота, работающего в модуле tg_bot.py. Бот отправляет логи (написанные в файле logs.py) по следующей логике:
- если бот включен, то он будет ждать, пока хотя бы один пользователь в нем зарегистрируется, введя к нему в чат с логином и паролем от бота, указанные в settings.py;
- после запускает параллельный процесс за счет библиотеки threading и цикла while, активируя отправку уведомлений;
- уведомления о стандартных логах будут отправляются согласно времени, которое стоит у вас в настройках к боту в settings.ph (ключ send_time). Если будут получены логи о критических ошибках, которые могут остановить или остановили работу бота ВК, то информация о таких ошибках будет отправлено сразу же в чат к пользователю, вне зависимости от того, какое время стоит в send_time. Бот будет отправлять файлы с логами всем пользователям, которые в нём зарегистрируются. После отправки, файлы с логами (logs_base.log, logs_error.log и starts_programm.log в директории logs) будут автоматически очищены, чтобы не засорять память.

## 8. Директория api_vk:

Директория содержит модуль main.py с классом SearchVK, который принимает токен от АПИ ВК. Данный класс предоставляет следующие методы:

- get_user_vk(self, user_id: int) - возвращает информацию о пользователе в ВК по его user_id. Функция вернёт словарь с информацией, если она найдется, или строчку, если с токен от АПИ ВК по каким-либо причинам станет недоступен;
- get_users_vk(count: int = 1000, **kwargs) - метод находит count пользователей в вк (по умолчанию 1000) по указанным фильтрам в kwargs. В работе программы используются следующие фильтры:
  
1) sex: int (1 or 2);
2) city: int;
3) online: int (1 or 2);
4) age_from: int;
5) age_to: int;
6) has_photo: int (0 or 1);
7) is_closed: bool;
8) fields: str;
9) is_closed: boole;

- get_photo_user(self, user_id: int, place='profile', max_count: int = 5) - метод, по указанному user_id, достает от 0 до max_count (по умолчанию до 5) фотографий с профиля (place='profile') или со стены (place='wall') пользователя. Возвращает словарь с id фотографиями и дополнительной информацией о них. Вернёт -1, если при взятии фотографий не обнаружится какой-либо информации, например, ссылки на фотографию, количество лайков и т.д.

## 9. Директория database:

Директория содержит в себе функции и классы, необходимые для работы с PostgreSQL и Redis:

1) _Директория crud_db_ - содержит в себе модули для работы моделями PostgreSQL. В них представлены CRUD запросы к базе данных на чтение, запись, удаление и обновление данных.
2) _Модуль init.py_ - модуль содержит класс Session, от которого наследуются все классы в модулях crud_db. Класс содержит в себе информацию о подключении к PostgreSQL и 1 метод на чтение всех данных из используемой модели.
3) _Модуль create_db_ - модуль предназначен для создание и удалении базы данных, создание моделей в БД и проверка их существования:
- create_object_db(path: str)** - функция приниет path (str) - подключение к PostgreSQL и создает базу данных. Если БД с таким именем уже существует или неверно указан параметр path, то функция ничего не создат. Вернёт кортеж со статусом о создании. Если первый элемент кортежа равен 1, значит БД успешно создала, если -1, значит произошла ошибка в подключении к БД, -2, значит БД уже существует;
- **check_bd(path_: str)** - функция проверяет, есть ли в БД таблицы, которые указаны в модуле models.py этой же директории. Если таблиц нет, вернёт True, если есть хотя бы одна таблица, то вызовит исключение SystemExit;
- **create_bd(info_path: str)** - функция ничего не возвращает. Создает таблицы в указанной по info_path базе данных;
- **delete_object_db(path: str)** - функция по указанному path удаляет базу данных. Если удаление произошло без ошибок, то вернёт кортеж (1, None), если возникли ошибки sqlalchemy.exc.OperationalError или UnicodeDecodeError, то вернёт кортеж (-1, е), где е - информация об ошибке;
- **create_bd_and_tables_if_not_exists()** - функция предназначена только для работы программы. Функция ничего не принимает, по указанным настройкам в settings.py произведёт безопасное созадние БД и таблиц на основании предыдущих функций. Если БД с указанным в настройках именем уже будет существовать, то функция не станет пересоздавать БД, чтобы не стереть все имеющиеся в ней данные. Аналогично происходит и с созданием таблиц. Функция вернёт число int со статусом работы функции, например - 1 всё создалось успешно, -1 - ничего не создалось, так как БД и таблицы в ней уже существуют, -2 - создание БД произошло, но таблицы не создались, -3 - создание БД не произошло, так как неправильно укано подключение к БД.

4) _Модуль models.py _- модели таблиц в PostgreSQL:
-  **Users** - модель пользователей бота. Хранит id_vk пользователей ВК, которые пользуются ботом;
-  **InfoUsers** - модель с информацией о пользователях из таблицы Users. Содержит в себе поля о фильтрах, такие как имя, фамилия, пол, возраст, город проживания и т.д.;
-  **SearchPeople** - модель под каждого пользователя из Users хранит список найденных анкет с пользователями вк. Хранит в себе поля, состоящие из id из таблицы Users и id пользователя, который будет показан пользователю из Users;
-  **BlackList и LikedList** - модели хранят в себе id пользователя из Users и id с именем пользователя, который занесён BlackList/LikedList. Первая модель отвечает за то, чтобы человек больше не показывался в анкетах, модель LikedList - для сохранения анкеты, чтобы была возможность показать её будущем;
-  **FiltersUsers** - модель хранит фильтры пользователей из таблицы Users, содержит в себе такие поля как пол, город, возраст от, возраст до и т.д.

Все таблицы связаны внешним ключом с таблицей Users и имеют следующую структуру:

![image](https://github.com/user-attachments/assets/11818c3d-a667-4518-aea4-5389dfc86032)

5) _Модуль requests_redis.py_ - содержит в себе функции для работы с Redis, позволяющие записывать в кэш различную информацию под каждого пользователя VK:

- **redis_connect(path, charset_)** - функция подключается в Redis и используется в последующих функциях данного модуля в качестве аргумента connect. По умолчанию имеет path тот, что указан в настройках settings.py к Редису. Возвращает объект redis.StrictRedis;
- **redis_set_person(id_user, message, connect)** - по ключу ```search_{id_user}``` записывает словарь message в список Redis. Функция ничего не возвращает;
- **redis_set_current_person(id_user, id_search_user, connect)** - функция ничего не возвращает. Устанавливает в кеше информацию о ток анкете, на который находится в текущий момент пользователь. Запись идет по ключу ```current_person_{id_user}```;
- **redis_get_current_person(id_user, connect)** - функция возвращает записанную строку функцией redis_set_current_person;
- **redis_get_person_info(id_user, connect)** - функция возвращает записанный словарь функцией redis_set_person;
- **redis_get_person_current_info(id_user, connect)** - функция получает словарь message (который записывается в redis_set_person) той анкеты, на которой в текущий момент находится пользователь в списке Redis по ключу ```search_{id_user}```;
- **redis_person_is_current(id_user, connect)** - функция проверяет, находится ли пользователь на текущей анкете в списке Redis по ключу ```search_{id_user}```. Возвращает bool значение;
- **redis_person_is_last(id_user, connect)** - функция проверяет, находится ли пользователь на последней анкете в списке Redis по ключу ```search_{id_user}```;
- **redis_get_prev_person(id_user, connect)** - функцию достается список Redis по ключу ```search_{id_user}``` и перемещает текущее значение анкеты на 1 шаг назад за счет функции redis_set_current_person();
- **redis_get_next_person(id_user, connect)** - функция аналогична предыдущей функции, только перемещает значение на 1 шаг вперёд;
- **redis_clear_user_id(id_user, connect)** - функция очищает кеш по ключу ```'current_person_{id_user}'``` и ```search_{id_user}```;
- **redis_save_history(id_user, message, size, connect)** - функция записывает в список Redis по ключу ```history_{id_user}``` информацию в словаре message о просматриваемых анкетах. Максимальное количество записей = size (по умолчанию 15). Если записывается запись в тот момент, когда в списке уже 15 записей, то та запись, которая была записана раньше всех - удаляется;
- **redis_browsing_history(id_user, connect)** - функция возвращает записанный message из функции redis_save_history по ключу ```history_{id_user}```;

## 10. Директория vk_bot:

В директории предоставлены три модуля, которые содержат основные функции для работы ВК бота.

1) _Модуль menu_button.py_ - содержит клавиши для диалога:
   
Все функции в данном модуле возвращают объект клавиаутуры - VkKeyboard из модуля vk_api.keyboard 
- **main_menu(id_vk)** - возвращает клавиатуру главного меню (клавиши "Найти половинку", "Фильтры поиска людей", "Like list", "Block list" и "История просмотров"). id_vk - id пользователя, кто вызвал клавиатуру в боте, данный аргумент нужен для отображения количество человек, которые его отметило.
- **filters_menu()** - возвращает Inline клавиатуру с выбором фильтров поиска людей;
- **search_inline(url_profile: str, id_vk: int, user_list_id: int, prev_none: bool = False)** - возвращает Inline клавиатуру с найденной анкетой; url_profile - ссылка на профиль для клавиши "Ссылка на профиль", id_vk - id пользователя, вызвавшего клавиатуру, нужно для Redis функций (чтобы определить значение кнопки "Предыдущей записи нет/Предыдущий человек"), user_list_id - id пользователя, который отображается в анкете. Нужно для того, чтобы определить значение клавиш "Больше не показывать/Убрать из игнорируемых" и "Сохранить в список/Удалить из списка". Например, если пользователь не добавил анкету с список игнорируемых, то одна из клавиш будет отображать значение "Больше не показывать", а если пользователь уже добавил в список игнорируемых, то значение данной клавиши будет "Убрать из игнорируемых";
- **like_block_list(people)** - функция возвращает Inline клавишу с сообщение "Очистить список".

2) _Модуль bot_function.py:_ - содержит функции, которые срабатывают при отправке пользователем сообщений в бот или нажатия им на клавиши клавиатур:

- **send_message(vk: VkApi, user_id: int, message: str, keyboard: Optional\[VkKeyboard\] = None, template: str = None, attachment: list = None)** - функция ничего не возвращает. Предназначена для отправки сообщения в чат пользователю user_id. Отправляет сообщение message. Дополнительно может отправить keyboard - клавиатуру из модуля meny_button.py, template - объект "карусели", attachment - список фотографий. Использует функцию из Vk библиотеки vk.method();
- **snow_snackbar(vk: VkApi, event_id: str, user_id: int, peer_id: int, event_data: str)** - отправка всплывающих сообщений, если пользователь нажал на клавишу типа "show_snackbar";
- **list_users(id_vk: int, list_user: str = 'Like list')** - Возвращает строку с пользователями из БД, list_user: like_pages - из таблицы LikedList, block_pages - из таблицы BlackList;
- **user_filters(id_user: int)** - возвращает строку с описание фильтров пользователя по id_user;
- **change_filter_age(id_vk: int, age: str) - принимает строку age в формате XX-XX или XX XX или >35 и обновляет запись в таблице UsersFilters в пользователя id_vk, ничего не возвращает;
- **change_filter_sex(id_vk: int, sex: str)** - изменяет фильтр пола на противоложный в таблице UsersFilters у пользователя id_vk, ничего не возвращает;
- **change_filter_status(id_vk: int, status: str)** - изменяет фильтр статуса в таблице UsersFilters у пользователя id_vk, возвращает строку 'Статус установлен' или 'Такой статус не доступен';
- **change_filter_city(id_vk: int, city: str)** - изменяет фильтр города на city в таблице UsersFilters у пользователя id_vk, возвращает строку 'Город установлен' или 'Такой город недоступен';
- **marks_person(id_vk: int)** - функция вычисляет, сколько людей отметило пользователя с id_vk, возвращает строку с информацией о количестве отметок;
- **get_message_search(id_vk: int)** - функция достает из SearchPeople первую попавшуюся запись, которая связана с записью из Users. Формирует выходное сообщение из информации, получаемой с методов get_user_vk и get_photo_user. Возвращает словарь с получившимся сообщением;
- **save_search_people(id_user: int, check: bool = False)** - функция проверяет, если ли в таблице SearchPeople записи с id_user, если нет ни одной записи, то функция записывает людей в SearchPeople. При check == True, функция перезапишет имеющиеся данные. Функция ничего не возвращает;
- **get_id_vk_users_photo(id_user: int)** - функция достает из профиля все фотографии пользователя id_user и составляет из них id в формате photo<id_user>_<id_photo>. Функция возвращает список получившихся id фотографий.

3) _Модуль untils.py_ - модуль с вспомогательными функцями:

- **decorator_check_users_or_create_him(id_vk: int)** - декоратор, который проверяет, записан ли id_vk в таблицу Users. Если записан, то вернёт результат оборачиваемой функции, если не записан, то запишет пользователя id_vk в таблицу Users, а также информацию о нем в таблицу InfoUsers и вернёт результат оборачиваемой функции;
- **choose_plural(amount: int, declensions: tuple[str, str, str])** - функция для склонения слов. Принимает число и 3 варианта его склонения, например, 91 ('день', 'дня', 'дней'). Принимает amount - количество (int), declensions - список склонений (кортеж строк). Возвращает строку, содержащую в себе число и правильное склонение;
- **calculate_age(date_: str)** - определяет возраст человека (в годах). Принимает дату в формате d.m.y. Если date_ соответствует формату ```%d.%m.%Y```, то вернёт количество лет (int), прошедших с момента date_, если не соответствует формату, то вернет строку 'возраст не определён';
- ** filter_age(birth_date: str, end_range: int = 5)** - вычисляет диапазон от количества лет с даты birth_date и значения end_range (по умолчанию 5), возвращает кортеж из двух целых чисел;
- ** format_for_filters_users(info: dict[str: str])** - берёт из словаря info только те значения, которые находятся в модели FiltersUsers и возвращает изменённый словарь;
- **message_status()** - функция возвращает словарь статусов и строку статусов;
- **message_city()** - функция возвращает словарь городов и строку городов.

> [!IMPORTANT]
> _О том, как взаимодействуют все функции проекта друг с другом, можно посмотреть в модуле vk_bot_main.py в главной директории проекта. Там описаны входящие сообщение от пользователя и возвращаемые ответы на них ботом._










